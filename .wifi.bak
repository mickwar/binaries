PREFER=apt_208:BYUSecure:THIRD_NETWORK
N=3
sudo ifconfig mlan0 up
for (( i=1; i <= N; i++ )); do
    # check which network to connect to (apt_208 or BYUSecure)
    ESSID=`echo $PREFER | cut -f $i -d ':'`
    if [[ -n `sudo iwlist mlan0 scan | grep "ESSID:\"$ESSID\""` ]]; then
        echo "Connecting to $ESSID ..."
        break
    fi
    if [ $i -eq $N ]; then
        echo "Unable to connect to preferred networks."
        exit 1
    fi
done
if [ ! \( -e ~/bin/.networks/$ESSID \) ]; then
    echo "No password file found for $ESSID."
    exit 1
fi
KEY=`cat ~/bin/.networks/$ESSID`
sudo ifconfig mlan0 down
sudo ifconfig mlan0 up
wpa_passphrase $ESSID $KEY > ~/.wpa.conf
sudo wpa_supplicant -B -imlan0 -c/home/mickey/.wpa.conf -Dwext 2> /dev/null
sudo dhclient -r mlan0
sudo dhclient mlan0
rm -f /home/mickey/.wpa.conf
